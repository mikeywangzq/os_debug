# GDB å®æ—¶é›†æˆ - æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ğŸ¯ ç›®æ ‡

å®ç°ä¸ GDB çš„å®æ—¶åŒå‘é€šä¿¡ï¼Œä½¿è°ƒè¯•åŠ©æ‰‹èƒ½å¤Ÿï¼š
- è‡ªåŠ¨è¿æ¥åˆ°è¿è¡Œä¸­çš„ GDB ä¼šè¯
- å®æ—¶ç›‘æ§ç¨‹åºçŠ¶æ€
- è‡ªåŠ¨æ•è·å´©æºƒå’Œå¼‚å¸¸
- æ‰§è¡Œè°ƒè¯•å‘½ä»¤å¹¶è·å–ç»“æœ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Web Browser (å‰ç«¯)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  è¿æ¥é¢æ¿    â”‚  â”‚  å®æ—¶æ—¥å¿—    â”‚  â”‚  è‡ªåŠ¨åˆ†æ    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                 â”‚
â”‚                      WebSocket                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flask Backend (åç«¯)                      â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚  WebSocket Handler (SocketIO)    â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚      GDB Bridge Manager          â”‚                â”‚
â”‚         â”‚  - è¿æ¥ç®¡ç†                      â”‚                â”‚
â”‚         â”‚  - ä¼šè¯çŠ¶æ€                      â”‚                â”‚
â”‚         â”‚  - å‘½ä»¤é˜Ÿåˆ—                      â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚      GDB/MI Parser               â”‚                â”‚
â”‚         â”‚  - è§£æ MI è¾“å‡º                  â”‚                â”‚
â”‚         â”‚  - æ ¼å¼åŒ–å“åº”                    â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                       GDB/MI Protocol
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          GDB                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  MI Interface (--interpreter=mi)                   â”‚     â”‚
â”‚  â”‚  - ç›‘å¬ç«¯å£: localhost:1234                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚                    Target Program                           â”‚
â”‚                   (xv6 / QEMU)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æŠ€æœ¯é€‰å‹

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å†³ç­– |
|------|------|------|------|
| **pygdbmi** | ç°æˆåº“ï¼Œç¨³å®š | é¢å¤–ä¾èµ– | âœ… é‡‡ç”¨ |
| **pexpect** | çµæ´»ï¼Œè½»é‡ | éœ€è¦è§£æ MI | âŒ å¤‡é€‰ |
| **è‡ªå·±å®ç°** | å®Œå…¨æ§åˆ¶ | å·¥ä½œé‡å¤§ | âŒ ä¸é‡‡ç”¨ |

**æœ€ç»ˆé€‰æ‹©**: `pygdbmi`

ç†ç”±ï¼š
- æˆç†Ÿç¨³å®šï¼Œä¸“ä¸º GDB/MI è®¾è®¡
- è‡ªåŠ¨å¤„ç† MI åè®®ç»†èŠ‚
- æ”¯æŒå¼‚æ­¥æ“ä½œ
- MIT è®¸å¯è¯ï¼Œå¼€æºå‹å¥½

### WebSocket æ–¹æ¡ˆ

ä½¿ç”¨ **Flask-SocketIO**

ä¼˜åŠ¿ï¼š
- ä¸ Flask æ— ç¼é›†æˆ
- æ”¯æŒæˆ¿é—´å’Œå‘½åç©ºé—´
- è‡ªåŠ¨é™çº§ï¼ˆWebSocket â†’ é•¿è½®è¯¢ï¼‰
- äº‹ä»¶é©±åŠ¨æ¶æ„

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. GDB Bridge (`backend/gdb/gdb_bridge.py`)

```python
class GDBBridge:
    """GDB è¿æ¥æ¡¥æ¥å™¨"""

    def __init__(self):
        self.gdb_process = None
        self.mi_parser = None
        self.connected = False

    def connect(self, target: str, port: int = None):
        """è¿æ¥åˆ° GDB æˆ–å¯åŠ¨æ–°çš„ GDB ä¼šè¯"""

    def execute_command(self, cmd: str) -> dict:
        """æ‰§è¡Œ GDB å‘½ä»¤å¹¶è¿”å›è§£æåçš„ç»“æœ"""

    def set_breakpoint(self, location: str):
        """è®¾ç½®æ–­ç‚¹"""

    def get_backtrace(self) -> list:
        """è·å–è°ƒç”¨æ ˆ"""

    def get_registers(self) -> dict:
        """è·å–å¯„å­˜å™¨çŠ¶æ€"""

    def read_memory(self, address: str, size: int) -> str:
        """è¯»å–å†…å­˜"""

    def continue_execution(self):
        """ç»§ç»­æ‰§è¡Œ"""

    def step(self):
        """å•æ­¥æ‰§è¡Œ"""
```

### 2. GDB Monitor (`backend/gdb/gdb_monitor.py`)

```python
class GDBMonitor:
    """å®æ—¶ç›‘æ§ GDB äº‹ä»¶"""

    def __init__(self, bridge: GDBBridge, socketio):
        self.bridge = bridge
        self.socketio = socketio
        self.monitoring = False

    def start_monitoring(self):
        """å¼€å§‹ç›‘æ§ï¼ˆç‹¬ç«‹çº¿ç¨‹ï¼‰"""

    def stop_monitoring(self):
        """åœæ­¢ç›‘æ§"""

    def on_stop_event(self, event):
        """ç¨‹åºåœæ­¢äº‹ä»¶ï¼ˆæ–­ç‚¹ã€å´©æºƒç­‰ï¼‰"""
        # è‡ªåŠ¨æŠ“å–ä¿¡æ¯
        # å‘é€åˆ°å‰ç«¯

    def on_breakpoint_hit(self, event):
        """æ–­ç‚¹å‘½ä¸­"""

    def on_signal_received(self, event):
        """ä¿¡å·æ¥æ”¶ï¼ˆSIGSEGV ç­‰ï¼‰"""
```

### 3. WebSocket Handler (`backend/gdb/websocket_handler.py`)

```python
@socketio.on('gdb_connect')
def handle_gdb_connect(data):
    """å¤„ç† GDB è¿æ¥è¯·æ±‚"""

@socketio.on('gdb_command')
def handle_gdb_command(data):
    """å¤„ç† GDB å‘½ä»¤"""

@socketio.on('gdb_disconnect')
def handle_gdb_disconnect():
    """å¤„ç†æ–­å¼€è¿æ¥"""
```

## ğŸ”„ å·¥ä½œæµç¨‹

### åœºæ™¯ 1: è¿æ¥åˆ°ç°æœ‰ GDB

```
ç”¨æˆ·æ“ä½œ:
1. åœ¨ç»ˆç«¯å¯åŠ¨ GDB: gdb -i=mi xv6-kernel
2. åœ¨ UI è¾“å…¥: localhost:1234
3. ç‚¹å‡» "Connect"

ç³»ç»Ÿæµç¨‹:
1. WebSocket å‘é€ connect è¯·æ±‚
2. Backend åˆ›å»º GDB Bridge
3. ä½¿ç”¨ pygdbmi è¿æ¥åˆ° GDB
4. å¼€å§‹ç›‘æ§çº¿ç¨‹
5. è¿”å›è¿æ¥æˆåŠŸçŠ¶æ€
6. å‰ç«¯æ˜¾ç¤º "Connected" çŠ¶æ€
```

### åœºæ™¯ 2: è‡ªåŠ¨æ•è·å´©æºƒ

```
ç¨‹åºæ‰§è¡Œ:
1. ç”¨æˆ·åœ¨ GDB ä¸­æ‰§è¡Œ 'run'
2. ç¨‹åºè§¦å‘ SIGSEGV

ç³»ç»Ÿè‡ªåŠ¨:
1. Monitor æ£€æµ‹åˆ° signal-received äº‹ä»¶
2. è‡ªåŠ¨æ‰§è¡Œ:
   - bt (backtrace)
   - info registers
   - info frame
3. è§£æè¾“å‡º
4. é€šè¿‡ WebSocket å‘é€åˆ°å‰ç«¯
5. å‰ç«¯è‡ªåŠ¨è°ƒç”¨åˆ†æ API
6. æ˜¾ç¤ºå‡è®¾å’Œå»ºè®®
```

### åœºæ™¯ 3: äº¤äº’å¼è°ƒè¯•

```
ç”¨æˆ·æ“ä½œ:
1. åœ¨ UI ä¸­ç‚¹å‡» "Set Breakpoint at panic"
2. ç‚¹å‡» "Continue"

ç³»ç»Ÿæµç¨‹:
1. WebSocket å‘é€å‘½ä»¤
2. Backend æ‰§è¡Œ GDB å‘½ä»¤
3. ç­‰å¾…æ–­ç‚¹å‘½ä¸­
4. è‡ªåŠ¨æŠ“å–çŠ¶æ€
5. å®æ—¶æ›´æ–° UI
```

## ğŸ“¡ GDB/MI åè®®è¦ç‚¹

### å‘½ä»¤æ ¼å¼

```
# æ‰§è¡Œå‘½ä»¤
-exec-run

# è®¾ç½®æ–­ç‚¹
-break-insert main

# è·å–å›æº¯
-stack-list-frames

# è¯»å–å¯„å­˜å™¨
-data-list-register-values x

# è¯»å–å†…å­˜
-data-read-memory-bytes 0x80000000 256
```

### å“åº”æ ¼å¼

```
# æˆåŠŸå“åº”
^done,frame={level="0",addr="0x80000abc",func="panic"}

# å¼‚æ­¥é€šçŸ¥
*stopped,reason="breakpoint-hit",bkptno="1"

# æµè¾“å‡º
~"Program received signal SIGSEGV\n"
```

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. è¿æ¥é™åˆ¶
- åªå…è®¸ localhost è¿æ¥
- å¯é€‰ï¼šå¯†ç ä¿æŠ¤
- ä¼šè¯è¶…æ—¶æœºåˆ¶

### 2. å‘½ä»¤ç™½åå•
```python
SAFE_COMMANDS = [
    'bt', 'backtrace',
    'info', 'print', 'x',
    'continue', 'step', 'next',
    'break', 'watch'
]

DANGEROUS_COMMANDS = [
    'shell', 'run', 'file',
    'set', 'delete'  # éƒ¨åˆ†å‘½ä»¤
]
```

### 3. èµ„æºé™åˆ¶
- æœ€å¤§è¾“å‡ºå¤§å°
- å‘½ä»¤æ‰§è¡Œè¶…æ—¶
- æœ€å¤§å¹¶å‘è¿æ¥æ•°

## ğŸ“Š æ•°æ®æµ

### 1. è¿æ¥å»ºç«‹

```
Frontend                Backend              GDB
   |                       |                  |
   |-- connect(host) ----->|                  |
   |                       |-- spawn/attach -->|
   |                       |<--- ready --------|
   |<--- connected --------|                  |
   |                       |                  |
```

### 2. å‘½ä»¤æ‰§è¡Œ

```
Frontend                Backend              GDB
   |                       |                  |
   |-- exec('bt') -------->|                  |
   |                       |-- MI: -stack---->|
   |                       |<--- MI response--|
   |                       |-- parse ---------|
   |<--- result -----------|                  |
```

### 3. äº‹ä»¶é€šçŸ¥

```
Frontend                Backend              GDB
   |                       |                  |
   |                       |<--- *stopped ----|
   |                       |-- auto capture --|
   |                       |-- analyze -------|
   |<--- push event -------|                  |
   |-- render UI --------->|                  |
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- GDB Bridge è¿æ¥/æ–­å¼€
- MI åè®®è§£æ
- å‘½ä»¤æ‰§è¡Œå’Œå“åº”

### é›†æˆæµ‹è¯•
- å®Œæ•´å·¥ä½œæµ
- WebSocket é€šä¿¡
- è‡ªåŠ¨æ•è·åŠŸèƒ½

### ç«¯åˆ°ç«¯æµ‹è¯•
- ä½¿ç”¨çœŸå® xv6 ç¨‹åº
- æ¨¡æ‹Ÿå´©æºƒåœºæ™¯
- éªŒè¯åˆ†æç»“æœ

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
```python
# ä½¿ç”¨å¼‚æ­¥ I/O
import asyncio
from pygdbmi.gdbcontroller import GdbController

async def execute_async(cmd):
    return await gdb.write(cmd, read_response=True)
```

### 2. ç¼“å­˜æœºåˆ¶
- ç¼“å­˜ç¬¦å·è¡¨ä¿¡æ¯
- ç¼“å­˜æºæ–‡ä»¶ä½ç½®
- ç¼“å­˜å¸¸ç”¨å‘½ä»¤ç»“æœ

### 3. æ‰¹é‡æ“ä½œ
```python
# ä¸€æ¬¡è·å–å¤šä¸ªä¿¡æ¯
commands = [
    '-stack-list-frames',
    '-data-list-register-values x',
    '-thread-info'
]
results = bridge.execute_batch(commands)
```

## ğŸš§ å·²çŸ¥é™åˆ¶

1. **GDB ç‰ˆæœ¬**: éœ€è¦ GDB 7.0+ (MI v2)
2. **å¹³å°**: Linux/macOS (Windows éœ€è¦ MinGW)
3. **å¹¶å‘**: ä¸€ä¸ªä¼šè¯åŒæ—¶åªèƒ½è¿æ¥ä¸€ä¸ª GDB
4. **æƒé™**: éœ€è¦èƒ½è®¿é—® GDB è¿›ç¨‹

## ğŸ“ é…ç½®é€‰é¡¹

```python
# backend/config.py
GDB_CONFIG = {
    'mi_version': 'mi2',
    'timeout': 30,  # ç§’
    'max_output_size': 1024 * 1024,  # 1MB
    'auto_capture': True,
    'allowed_hosts': ['localhost', '127.0.0.1'],
    'enable_security': True
}
```

## ğŸ¯ é‡Œç¨‹ç¢‘

### M1: åŸºç¡€è¿æ¥ (1-2 å¤©)
- [x] pygdbmi é›†æˆ
- [x] åŸºç¡€å‘½ä»¤æ‰§è¡Œ
- [x] WebSocket é€šä¿¡

### M2: è‡ªåŠ¨ç›‘æ§ (1 å¤©)
- [ ] äº‹ä»¶ç›‘å¬
- [ ] è‡ªåŠ¨ä¿¡æ¯æ•è·
- [ ] å®æ—¶æ¨é€

### M3: UI é›†æˆ (1 å¤©)
- [ ] è¿æ¥é¢æ¿
- [ ] å®æ—¶æ—¥å¿—
- [ ] å‘½ä»¤è¾“å…¥

### M4: ä¼˜åŒ–å’Œæµ‹è¯• (1 å¤©)
- [ ] é”™è¯¯å¤„ç†
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å®Œæ•´æµ‹è¯•

---

**æ€»é¢„ä¼°**: 3-5 å¤©å®Œæ•´å®ç°

**å¼€å§‹æ—¥æœŸ**: 2025-11-17
**ç›®æ ‡å®Œæˆ**: 2025-11-22
